name: Deploy Trader Server To Alibaba Cloud

on:
  push:
    branches:
      - main  # 监听 main 分支的变动

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 检出代码
    - name: Checkout code
      uses: actions/checkout@v3

    # 设置 Node.js 版本
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    # 创建 .env 文件
    - name: Create env file
      run: |
        cat > .env << 'ENVFILE'
        # 基础配置
        NODE_ENV=production
        PORT=${{ secrets.PORT }}
        BASE_URL=${{ secrets.BASE_URL }}
        PRODUCTION_URL=${{ secrets.PRODUCTION_URL }}

        # 数据库配置
        DB_HOST=${{ secrets.DB_HOST }}
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=${{ secrets.DB_NAME }}

        # JWT配置
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}

        # 七牛云配置
        QINIU_ACCESS_KEY=${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY=${{ secrets.QINIU_SECRET_KEY }}
        QINIU_BUCKET=${{ secrets.QINIU_BUCKET }}
        QINIU_DOMAIN=${{ secrets.QINIU_DOMAIN }}

        # 跨域配置
        CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
        ENVFILE

    # 安装依赖
    - name: Install dependencies
      run: |
        npm install
        npm install pm2 -g

    # 打包文件
    - name: Archive production files
      run: |
        echo "Creating tar archive..."
        ls -la
        echo "Files to be archived:"
        find . -type f -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./logs/*"
        tar --exclude='node_modules' --exclude='.git' --exclude='logs' -czvf trader-server.tar.gz * .env
        echo "Archive created:"
        ls -la trader-server.tar.gz
        echo "Archive contents:"
        tar -tvf trader-server.tar.gz

    # 添加服务器主机密钥
    - name: Add SSH Host Key
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    # 部署到阿里云
    - name: Deploy to Alibaba Cloud
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        APP_DIR: ${{ secrets.SERVER_APP_DIR }}
      run: |
        echo "$SSH_PRIVATE_KEY" > private_key
        chmod 600 private_key
        echo "Uploading files to server..."
        scp -i private_key trader-server.tar.gz $SERVER_USER@$SERVER_HOST:$APP_DIR
        echo "Executing deployment commands..."
        ssh -i private_key $SERVER_USER@$SERVER_HOST << 'SSHEOF'
        cd $APP_DIR
        echo "Current directory: $(pwd)"
        echo "Cleaning up previous files..."
        rm -rf *.js *.json config routes middleware scripts logs public
        
        echo "Extracting archive..."
        if [ -f trader-server.tar.gz ]; then
            tar -xzvf trader-server.tar.gz
            echo "Archive contents:"
            ls -la
            
            if [ -f package.json ]; then
                echo "package.json found"
                echo "Installing dependencies..."
                npm install --omit=dev
            else
                echo "Error: package.json not found after extraction"
                exit 1
            fi
        else
            echo "Error: trader-server.tar.gz not found"
            exit 1
        fi
        
        echo "Creating directories..."
        mkdir -p logs public/uploads
        chmod 755 public/uploads
        
        echo "Starting PM2..."
        echo "Checking ecosystem.config.js..."
        cat ecosystem.config.js
        if [ -f ecosystem.config.js ]; then
            echo "Found ecosystem.config.js"
            pm2 list | grep "trader-server" > /dev/null && pm2 delete "trader-server"
            pm2 start ecosystem.config.js --env production
            echo "PM2 started successfully"
        else
            echo "Error: ecosystem.config.js not found"
            exit 1
        fi
        
        echo "Cleaning up..."
        if [ -f trader-server.tar.gz ]; then
            rm trader-server.tar.gz
            echo "Cleaned up archive file"
        fi
        echo "Deployment completed"
        SSHEOF

    # 部署完成通知
    - name: Deployment notification
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ 部署成功！"
        else
          echo "❌ 部署失败！"
        fi 