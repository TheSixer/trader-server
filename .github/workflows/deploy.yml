name: Deploy Trader Server to Alibaba Cloud

on:
  push:
    branches:
      - main  # ç›‘å¬ main åˆ†æ”¯çš„å˜åŠ¨

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v3

    # è®¾ç½® Node.js ç‰ˆæœ¬
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    # å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: yarn install --frozen-lockfile

    # åˆ›å»º .env æ–‡ä»¶
    - name: Create env file
      run: |
        cat > .env << 'EOF'
        # ç¯å¢ƒå˜é‡é…ç½®
        NODE_ENV=production
        PORT=${{ secrets.PORT }}
        BASE_URL=${{ secrets.BASE_URL }}
        PRODUCTION_URL=${{ secrets.PRODUCTION_URL }}
        
        # æ•°æ®åº“
        DB_HOST=${{ secrets.DB_HOST }}
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=${{ secrets.DB_NAME }}

        # JWT é…ç½®
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }}

        # ä¸ƒç‰›äº‘é…ç½®
        QINIU_ACCESS_KEY=${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY=${{ secrets.QINIU_SECRET_KEY }}
        QINIU_BUCKET=${{ secrets.QINIU_BUCKET }}
        QINIU_DOMAIN=${{ secrets.QINIU_DOMAIN }}

        # CORS è·¨åŸŸé…ç½®
        CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
        EOF

    # æ‰“åŒ…æ–‡ä»¶
    - name: Archive production files
      run: |
        echo "Creating tar archive..."
        tar -czf trader-server.tar.gz \
          app.js \
          ecosystem.config.js \
          package.json \
          yarn.lock \
          .env \
          config/ \
          routes/ \
          middleware/ \
          scripts/
        echo "âœ” Archive completed: trader-server.tar.gz"

    # æ·»åŠ æœåŠ¡å™¨ä¸»æœºå¯†é’¥ï¼Œé˜²æ­¢ SSH æç¤º
    - name: Add SSH Host Key
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        echo "âœ” SSH host key added."

    # éƒ¨ç½²åˆ°é˜¿é‡Œäº‘
    - name: Deploy to Alibaba Cloud
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        APP_DIR: ${{ secrets.SERVER_APP_DIR }}
      run: |
        # ä¿å­˜ SSH ç§é’¥
        echo "$SSH_PRIVATE_KEY" > private_key
        chmod 600 private_key

        # æ‰‹åŠ¨éªŒè¯æ˜¯å¦å¯ä»¥ SSH è¿æ¥
        echo "ğŸš€ Verifying SSH connectivity..."
        ssh -i private_key $SERVER_USER@$SERVER_HOST "echo 'SSH connection successful'"

        # ä¸Šä¼ æ–‡ä»¶
        echo "ğŸš€ Uploading archive..."
        scp -i private_key trader-server.tar.gz $SERVER_USER@$SERVER_HOST:$APP_DIR

        # è¿œç¨‹éƒ¨ç½²è„šæœ¬
        echo "ğŸš€ Running remote deployment script..."
        ssh -i private_key $SERVER_USER@$SERVER_HOST << 'EOF'
        set -e  # æ•è·é”™è¯¯ï¼Œä»»ä½•å¤±è´¥éƒ½ä¸­æ­¢
        
        echo "ğŸ¯ Starting Deployment"
        echo "ğŸ“‚ Current directory: $(pwd)"
        echo "ğŸ“‚ APP_DIR directory: $APP_DIR"
        echo "âœ… GitHub Actions ENV -> APP_DIR = ${{ secrets.SERVER_APP_DIR }}"
        cd $APP_DIR
        ls -la  # ç¡®è®¤ç›®å½•å†…å®¹
        
        # ä¿®æ­£ä¸Šä¼ æ–‡ä»¶çš„æƒé™
        chmod +r trader-server.tar.gz

        # ç­‰å¾…æ–‡ä»¶ä¼ è¾“å®Œæˆ
        sleep 2

        # ç¡®è®¤è§£å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "trader-server.tar.gz" ]; then
            echo "âŒ Error: trader-server.tar.gz not found! Listing contents..."
            ls -la
            exit 1
        fi

        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p logs public/uploads
        
        # æ¸…ç†æ—§æ–‡ä»¶ï¼Œé¿å…æ®‹ç•™
        echo "ğŸ›  Cleaning old deployment..."
        rm -rf *.js *.json config routes middleware scripts

        # è§£å‹
        echo "ğŸ“¦ Extracting archive..."
        tar --overwrite -xzf trader-server.tar.gz
        echo "âœ… Extraction completed"
        
        # å†æ¬¡ç¡®è®¤å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "ecosystem.config.js" ]; then
            echo "âŒ Error: ecosystem.config.js not found after extraction!"
            exit 1
        fi

        # å®‰è£…ä¾èµ–
        echo "ğŸ“¥ Installing dependencies..."
        yarn install --production

        # å¯åŠ¨åº”ç”¨
        echo "ğŸš€ Starting application..."
        pm2 delete "trader-server" || true
        pm2 start ecosystem.config.js --env production
        pm2 save

        # æ¸…ç†å‹ç¼©åŒ…
        echo "ğŸ—‘ Cleaning up temporary files..."
        rm -f trader-server.tar.gz
        echo "âœ… Deployment completed successfully!"
        EOF

    # éƒ¨ç½²å®Œæˆé€šçŸ¥
    - name: Deployment notification
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼ğŸ‰"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼ğŸš¨"
        fi